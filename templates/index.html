<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Spotify Graph Explorer</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <style>
        /* --- Estilo Global (Tema Spotify Dark) --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            background: #121212; 
            color: white; 
            overflow: hidden;
        }

        /* --- Barra Lateral --- */
        #sidebar {
            width: 320px; 
            padding: 25px; 
            background: #000000; 
            border-right: 1px solid #282828;
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.5);
            z-index: 10;
        }

        h2 { color: #1DB954; margin: 0 0 10px 0; font-size: 24px; letter-spacing: -0.5px; }
        p.subtitle { font-size: 12px; color: #b3b3b3; margin-top: -10px; margin-bottom: 15px; }

        label { font-size: 11px; color: #b3b3b3; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        
        select { 
            padding: 10px; 
            background: #333; 
            color: white; 
            border: 1px solid #444; 
            border-radius: 4px; 
            outline: none; 
            width: 100%;
            margin-bottom: 5px;
        }
        select:focus { border-color: #1DB954; }

        /* --- Bot√µes --- */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        
        button {
            padding: 12px; 
            border-radius: 25px; 
            border: none; 
            font-size: 13px; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            transition: all 0.2s;
            text-transform: uppercase;
        }
        button:hover { filter: brightness(1.1); transform: scale(1.02); }
        button:active { transform: scale(0.95); }
        
        .btn-bfs { background-color: #8e44ad; }    /* Roxo */
        .btn-dfs { background-color: #2980b9; }    /* Azul */
        .btn-dijk { background-color: #d35400; }   /* Laranja */
        .btn-bf { background-color: #c0392b; }     /* Vermelho */
        
        .btn-reset { 
            background-color: transparent; 
            border: 1px solid #555; 
            color: #ccc;
            width: 100%; 
            margin-top: auto; /* Empurra para o final */
        }
        .btn-reset:hover { border-color: white; color: white; }

        /* --- √Årea de Feedback --- */
        #output { 
            margin-top: 15px; 
            padding: 15px; 
            background: #181818; 
            border-radius: 8px; 
            min-height: 60px; 
            font-size: 13px; 
            line-height: 1.5; 
            border-left: 4px solid #1DB954;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .loader { 
            display: none; 
            color: #1DB954; 
            font-size: 12px; 
            text-align: center; 
            margin-top: 10px;
            font-weight: bold;
        }

        /* --- √Årea do Grafo --- */
        #network { 
            flex-grow: 1; 
            height: 100%; 
            background: radial-gradient(circle at center, #222 0%, #121212 100%); 
        }
        
        /* Dica flutuante */
        .hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #aaa;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div>
        <h2>Spotify Graph üéµ</h2>
        <p class="subtitle">Explorador de Colabora√ß√µes</p>
    </div>
    
    <label>Artista de Origem (Start)</label>
    <select id="startSelect"><option>Carregando...</option></select>

    <label>Artista de Destino (End)</label>
    <select id="endSelect"><option>Carregando...</option></select>

    <label style="margin-top: 10px; display:block;">Explora√ß√£o (1 Fonte)</label>
    <div class="btn-group">
        <button class="btn-bfs" onclick="runAlgo('bfs')" title="Busca em Largura">BFS</button>
        <button class="btn-dfs" onclick="runAlgo('dfs')" title="Busca em Profundidade">DFS</button>
    </div>

    <label style="margin-top: 15px; display:block;">Caminho M√≠nimo (Start &rarr; End)</label>
    <div class="btn-group">
        <button class="btn-dijk" onclick="runAlgo('dijkstra')" title="Caminho mais curto (Pesos Positivos)">Dijkstra</button>
        <button class="btn-bf" onclick="runAlgo('bellman_ford')" title="Detecta ciclos negativos">Bellman-Ford</button>
    </div>

    <div id="loading" class="loader">PROCESSANDO NO PYTHON...</div>
    <div id="output">Selecione os artistas e escolha um algoritmo para come√ßar.</div>

    <button class="btn-reset" onclick="resetGraph()">Limpar / Resetar Zoom</button>
</div>

<div id="network"></div>
<div class="hint">Dica: Clique nas linhas para ouvir a m√∫sica no Spotify.</div>

<script type="text/javascript">
    var network = null;
    var nodesDataset = new vis.DataSet();
    var edgesDataset = new vis.DataSet();

    async function initGraph() {
        try {
            const response = await fetch('/api/graph');
            const data = await response.json();

            nodesDataset.add(data.nodes);
            edgesDataset.add(data.edges);

            populateSelects(data.nodes);

            var container = document.getElementById('network');
            var options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: { size: 14, color: '#ffffff', strokeWidth: 2, strokeColor: '#000' },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    color: { color: '#444', highlight: '#1DB954', hover: '#1DB954' },
                    smooth: { type: 'continuous', roundness: 0.5 },
                    selectionWidth: 3
                },
                physics: {
                    forceAtlas2Based: { 
                        gravitationalConstant: -30, 
                        centralGravity: 0.003, 
                        springLength: 200, 
                        springConstant: 0.08 
                    },
                    maxVelocity: 50,
                    solver: 'forceAtlas2Based',
                    timestep: 0.35,
                    stabilization: { iterations: 100 } 
                },
                interaction: { 
                    hover: true, 
                    tooltipDelay: 200,
                    zoomView: true,
                    dragView: true
                }
            };
            
            network = new vis.Network(container, {nodes: nodesDataset, edges: edgesDataset}, options);
            setupNetworkEvents();

        } catch (error) {
            document.getElementById('output').innerText = "Erro ao carregar grafo. O servidor Python est√° rodando?";
            console.error(error);
        }
    }

    function setupNetworkEvents() {
        network.on("selectEdge", function (params) {
            if (params.edges.length > 0 && params.nodes.length === 0) {
                var edgeId = params.edges[0];
                var edgeData = edgesDataset.get(edgeId);
                
                if (edgeData && edgeData.track_name) {
                    var query = `${edgeData.track_name} ${edgeData.artist_1} ${edgeData.artist_2}`;
                    
                    var url = `https://open.spotify.com/search/${encodeURIComponent(query)}`;
                    
                    document.getElementById('output').innerHTML = `üéµ Abrindo Spotify para: <br><strong>${edgeData.track_name}</strong>`;
                    
                    window.open(url, '_blank');
                    
                    network.unselectAll();
                }
            }
        });

        network.on("hoverEdge", function (params) {
            document.getElementById('network').style.cursor = 'pointer';
        });
        network.on("blurEdge", function (params) {
            document.getElementById('network').style.cursor = 'default';
        });
    }

    function populateSelects(nodes) {
        const startSelect = document.getElementById('startSelect');
        const endSelect = document.getElementById('endSelect');
        startSelect.innerHTML = ''; endSelect.innerHTML = '';

        nodes.sort((a,b) => a.label.localeCompare(b.label));

        nodes.forEach(node => {
            const opt1 = new Option(node.label, node.id);
            const opt2 = new Option(node.label, node.id);
            startSelect.add(opt1);
            endSelect.add(opt2);
        });

        if (endSelect.options.length > 1) endSelect.selectedIndex = 1;
    }

    async function runAlgo(type) {
        const startNode = document.getElementById('startSelect').value;
        const endNode = document.getElementById('endSelect').value;
        const outputDiv = document.getElementById('output');
        const loader = document.getElementById('loading');

        if ((type === 'dijkstra' || type === 'bellman_ford') && startNode === endNode) {
            outputDiv.innerHTML = "<span style='color:#e74c3c'>Erro:</span> A origem e o destino s√£o iguais.";
            return;
        }

        resetGraph(false); 
        loader.style.display = 'block';
        outputDiv.innerText = "Calculando...";

        try {
            const url = `/api/run_algo?type=${type}&start=${encodeURIComponent(startNode)}&end=${encodeURIComponent(endNode)}`;
            const response = await fetch(url);
            const result = await response.json();
            
            loader.style.display = 'none';
            
            if (result.error) {
                outputDiv.innerHTML = `<span style='color:#e74c3c'>Erro:</span> ${result.error}`;
                return;
            }

            outputDiv.innerHTML = result.info || "Algoritmo conclu√≠do.";

            if(result.path && result.path.length > 0) {
                if (type === 'dijkstra' || type === 'bellman_ford') {
                    highlightPath(result.path);
                } else {
                    animateExploration(result.path);
                }
            }

        } catch (e) {
            loader.style.display = 'none';
            outputDiv.innerText = "Erro de conex√£o com o Python.";
            console.error(e);
        }
    }

    function highlightPath(path) {
        const allNodes = nodesDataset.getIds();
        const allEdges = edgesDataset.getIds();
        
        nodesDataset.update(allNodes.map(id => ({id: id, color: '#333', opacity: 0.1})));
        edgesDataset.update(allEdges.map(id => ({id: id, color: '#333', opacity: 0.05})));

        const nodeUpdates = path.map((id, index) => {
            let color = '#f1c40f'; 
            let size = 25;
            if (index === 0) { color = '#3498db'; size = 35; } 
            if (index === path.length -1) { color = '#e74c3c'; size = 35; }
            
            return { id: id, color: { background: color, border: '#fff' }, opacity: 1, size: size };
        });
        nodesDataset.update(nodeUpdates);

        const edgeUpdates = [];
        for(let i=0; i < path.length - 1; i++) {
            const u = path[i];
            const v = path[i+1];
            const edges = network.getConnectedEdges(u);
            edges.forEach(edgeId => {
                const edge = edgesDataset.get(edgeId);
                if (edge.to === v || edge.from === v) {
                    edgeUpdates.push({ id: edgeId, color: '#f1c40f', width: 4, opacity: 1 });
                }
            });
        }
        edgesDataset.update(edgeUpdates);
        
        if (path.length > 0) network.fit({ nodes: path, animation: true });
    }

    function animateExploration(path) {
        let i = 0;
        const allIds = nodesDataset.getIds();
        nodesDataset.update(allIds.map(id => ({id: id, color: '#222', opacity: 0.2})));

        function step() {
            if (i >= path.length) return;
            
            nodesDataset.update({
                id: path[i], 
                color: { background: '#1DB954', border: '#fff' }, 
                opacity: 1,
                size: 25
            });
            
            i++;
            const delay = path.length > 500 ? 5 : 50; 
            setTimeout(step, delay);
        }
        step();
    }

    function resetGraph(resetView = true) {
        const allNodes = nodesDataset.getIds();
        const allEdges = edgesDataset.getIds();
        
        nodesDataset.update(allNodes.map(id => ({
            id: id, color: null, opacity: 1, size: 20 // Volta ao padr√£o do options
        })));
        
        edgesDataset.update(allEdges.map(id => ({
            id: id, color: null, width: 2, opacity: 1
        })));

        document.getElementById('output').innerText = "Visualiza√ß√£o limpa.";
        if(resetView) network.fit({animation: true});
    }

    window.onload = initGraph;
</script>
</body>
</html>